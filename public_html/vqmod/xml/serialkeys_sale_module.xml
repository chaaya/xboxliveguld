<modification>
	<id>Serial Keys Sale Module</id>
	<version>4.3</version>
	<vqmver>2.5.1</vqmver>
	<author>Dmonco - foridev.com</author>
	<email>support@foridev.com</email>
	<!-- ADMIN MODS -->
	<!-- SETTINGS EDIT -->
	<file name="admin/view/template/setting/setting.tpl">
		<operation error="log">
			<search position="before" offset="1"><![CDATA[
			<?php echo $text_affiliate; ?>
			]]></search>
			<add><![CDATA[
			<!-- RESTRICT SHOPPING -->
			<fieldset>
                <legend><?php echo $text_restrict_shopping; ?></legend>
			<div class="form-group">
			<label class="col-sm-2 control-label"><span data-toggle="tooltip" title="<?php echo $entry_restrict_checkout; ?>"><?php echo $entry_restrict_checkout; ?></span></label>
			<div class="col-sm-10">
                    <label class="radio-inline">
                      <?php if ($config_restrict_checkout) { ?>
                      <input type="radio" name="config_restrict_checkout" value="1" checked="checked" />
                      <?php echo $text_yes; ?>
                      <?php } else { ?>
                      <input type="radio" name="config_restrict_checkout" value="1" />
                      <?php echo $text_yes; ?>
                      <?php } ?>
                    </label>
					<label class="radio-inline">
                    <?php if (!$config_restrict_checkout) { ?>
                    <input type="radio" name="config_restrict_checkout" value="0" checked="checked" />
                    <?php echo $text_no; ?>
                    <?php } else { ?>
                    <input type="radio" name="config_restrict_checkout" value="0" />
                    <?php echo $text_no; ?>
                    <?php } ?>
                  </label>
			</div>
			</div>
			<div class="form-group">
			<label class="col-sm-2 control-label" for="config_restrict_hours"><span data-toggle="tooltip" title="<?php echo $entry_restrict_hours; ?>"><?php echo $entry_restrict_hours; ?></span></label>
			<div class="col-sm-10">
                    <input type="text" name="config_restrict_hours" value="<?php echo $config_restrict_hours; ?>" placeholder="<?php echo $entry_restrict_hours; ?>" id="config_restrict_hours" class="form-control" />
			</div>

		  </div>
		  </fieldset>
          <!-- RESTRICT SHOPPING END -->
			]]></add>
		</operation>
		<operation error="log">
			<search position="after" offset="2"><![CDATA[
			echo $config_mail_alert
			]]></search>
			<add><![CDATA[
			<div class="form-group">
                <label class="col-sm-2 control-label" for="input-stock_notify"><span data-toggle="tooltip" title="<?php echo $entry_stock_notify; ?>"><?php echo $entry_stock_notify; ?></span></label>
                <div class="col-sm-10">
                  <input type="text" name="config_stock_notify" value="<?php echo $config_stock_notify; ?>" placeholder="<?php echo $config_stock_notify; ?>" size="3" id="config_stock_notify" />
                </div>
              </div>
			]]></add>
		</operation>
	</file>
	<file name="admin/controller/setting/setting.php">
		<operation error="log">
			<search position="after"><![CDATA[
			$data['text_stock'] = $this->language->get('text_stock');
			]]></search>
			<add><![CDATA[
			/* RESTRICT SHOPPING */
		$data['text_restrict_shopping'] = $this->language->get('text_restrict_shopping');
		$data['entry_restrict_checkout'] = $this->language->get('entry_restrict_checkout');
		$data['entry_restrict_hours'] = $this->language->get('entry_restrict_hours');
		$data['entry_stock_notify'] = $this->language->get('entry_stock_notify');
		/* RESTRICT SHOPPING END */
			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[
			isset($this->request->post['config_stock_checkout'])
			]]></search>
			<add><![CDATA[
			/* RESTRICT SHOPPING */
		if (isset($this->request->post['config_restrict_checkout'])) {
			$data['config_restrict_checkout'] = $this->request->post['config_restrict_checkout'];
		} else {
			$data['config_restrict_checkout'] = $this->config->get('config_restrict_checkout');
		}

		if (isset($this->request->post['config_restrict_hours'])) {
			$data['config_restrict_hours'] = $this->request->post['config_restrict_hours'];
		} else {
			$data['config_restrict_hours'] = $this->config->get('config_restrict_hours');
		}

		if (isset($this->request->post['config_stock_notify'])) {
			$data['config_stock_notify'] = $this->request->post['config_stock_notify'];
		} else {
			$data['config_stock_notify'] = $this->config->get('config_stock_notify');
			if ($this->config->get('config_stock_notify') <= 2) {
			$data['config_stock_notify'] = 5;
			}
		}
		/* RESTRICT SHOPPING END */
			]]></add>
		</operation>
	</file>
	<file name="admin/language/*/setting/setting.php">
		<operation error="log">
			<search position="before"><![CDATA[
			$_['entry_affiliate']
			]]></search>
			<add><![CDATA[
			/* RESTRICT SHOPPING */
$_['text_restrict_shopping']       = 'Restrict shopping';
$_['entry_restrict_checkout']      = 'Restrict checkout';
$_['entry_restrict_hours']         = 'Hours to restrict before the next purchase';
$_['entry_stock_notify']           = 'Notify admin by email when lack of serial keys';
/* END RESTRICT SHOPPING */
			]]></add>
		</operation>
	</file>
	<!-- SETTINGS EDIT END -->
	<!-- PRODUCT EDIT -->
	<file name="admin/model/catalog/product.php">
		<operation error="skip">
			<search position="after"><![CDATA[$this->event->trigger('pre.admin.product.add', $data);]]></search>
			<add><![CDATA[$is_checked = (isset($data['saleserials']) ? 'Y' : 'N');
$is_checkedlink = (isset($data['saledownloadlinks']) ? 'Y' : 'N');]]></add>
		</operation>
		<operation error="skip">
			<search position="iafter"><![CDATA[, date_added = NOW()]]></search>
			<add><![CDATA[, saleserials = '" . $this->db->escape($is_checked) . "', saledownloadlinks = '" . $this->db->escape($is_checkedlink) . "']]></add>
		</operation>
		<operation error="log">
			<search position="after" index="1"><![CDATA[
foreach ($product_attribute['product_attribute_description'] as $language_id => $product_attribute_description) {
]]></search>
			<add><![CDATA[
$product_attribute_description['text'] = html_entity_decode($product_attribute_description['text'], ENT_QUOTES, 'UTF-8');
]]></add>
		</operation>
		<operation error="log">
			<search position="after" index="2"><![CDATA[
foreach ($product_attribute['product_attribute_description'] as $language_id => $product_attribute_description) {
]]></search>
			<add><![CDATA[
$product_attribute_description['text'] = html_entity_decode($product_attribute_description['text'], ENT_QUOTES, 'UTF-8');
]]></add>
		</operation>
		<operation error="log">
			<search position="before" index="1"><![CDATA[
if (isset($data['product_category'])) {
]]></search>
			<add><![CDATA[

		if (isset($data['serialkey'])) {
		$testserials =  preg_replace('/[^0-9a-zA-Z]*/', '', $data['serialkey']);
		  if( $testserials != "") {
		  $serialkeytodb = array();
			$data['serialkey'] = explode("\n",$data['serialkey']);
			foreach ($data['serialkey'] as $serialkey) {
			$serialkey1 = preg_replace('/[^0-9a-zA-Z]*/', '', $serialkey);
			    if ($serialkey1 != "") {
				$this->db->query("INSERT INTO " . DB_PREFIX . "serialkeys SET product_id = '" . (int)$product_id . "', serialkey = '" . str_replace("\r",'',$serialkey) . "'");
				$serialkeytodb[] = $serialkey;
				}
			}
			if ($is_checked=='Y') {

				$this->db->query("UPDATE " . DB_PREFIX . "product SET quantity = '" . count($serialkeytodb) . "' WHERE product_id = '" . (int)$product_id . "'");
			}
	      }
		}

		if (!empty($data['downloadlink'])) {


			foreach ($data['downloadlink'] as $lang=>$downloadlink) {
				$this->db->query("INSERT INTO " . DB_PREFIX . "downloadlinks SET language_id = '".$lang."', product_id = '" . (int)$product_id . "', downloadlink = '" . str_replace("\r",'',$downloadlink) . "'");
			}
		}

		if (!empty($data['article'])) {
			$article = $data['article'];

			$this->db->query("INSERT INTO " . DB_PREFIX . "product_article SET  product_id = '" . (int)$product_id . "', article_id = '" . (int)$article . "'");

		}

]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$this->event->trigger('pre.admin.product.edit', $data);]]></search>
			<add><![CDATA[
$data['saleserials'] = isset($data['saleserials']) ? $data['saleserials'] : 'N';
$data['saledownloadlinks'] = isset($data['saledownloadlinks']) ? $data['saledownloadlinks'] : 'N';]]></add>
		</operation>
		<operation error="skip">
			<search position="iafter"><![CDATA[, date_modified = NOW()]]></search>
			<add><![CDATA[, saleserials = '" . $data['saleserials'] . "', saledownloadlinks = '" . $data['saledownloadlinks'] . "']]></add>
		</operation>
		<operation error="log">
			<search position="before" index="1"><![CDATA[
$this->db->query("DELETE FROM " . DB_PREFIX . "product_to_category WHERE product_id = '" . (int)$product_id . "'");
]]></search>
			<add><![CDATA[

		$this->db->query("DELETE FROM " . DB_PREFIX . "serialkeys WHERE product_id = '" . (int)$product_id . "'");

		if (isset($data['serialkey'])) {
		$testserials =  preg_replace('/[^0-9a-zA-Z]*/', '', $data['serialkey']);
		  if( $testserials != "") {
		  $serialkeytodb = array();
			$data['serialkey'] = explode("\n",$data['serialkey']);
			foreach ($data['serialkey'] as $serialkey) {
			    $serialkey1 = preg_replace('/[^0-9a-zA-Z]*/', '', $serialkey);
			    if ($serialkey1 != "") {
				$this->db->query("INSERT INTO " . DB_PREFIX . "serialkeys SET product_id = '" . (int)$product_id . "', serialkey = '" . str_replace("\r",'',$serialkey) . "'");
				$serialkeytodb[] = $serialkey;
				}
			}
			if ($data['saleserials']=='Y') {

				$this->db->query("UPDATE " . DB_PREFIX . "product SET quantity = '" . count($serialkeytodb) . "' WHERE product_id = '" . (int)$product_id . "'");
			}
          }
		}

		$this->db->query("DELETE FROM " . DB_PREFIX . "downloadlinks WHERE product_id = '" . (int)$product_id . "'");

		if (isset($data['downloadlink'])) {


			foreach ($data['downloadlink'] as $lang=>$downloadlink) {
				$this->db->query("INSERT INTO " . DB_PREFIX . "downloadlinks SET language_id = '".$lang."', product_id = '" . (int)$product_id . "', downloadlink = '" . str_replace("\r",'',$downloadlink) . "'");
			}
		}
		$this->db->query("DELETE FROM " . DB_PREFIX . "product_article WHERE product_id = '" . (int)$product_id . "'");

		if (isset($data['article'])) {
			$article = $data['article'];

			$this->db->query("INSERT INTO " . DB_PREFIX . "product_article SET  product_id = '" . (int)$product_id . "', article_id = '" . (int)$article . "'");

		}


]]></add>
		</operation>

		<operation error="log">
			<search position="after"><![CDATA[
$this->getProductLayouts($product_id);
]]></search>
			<add trim="true"><![CDATA[
$data['product_serialkey'] = $this->getSerialkeys($product_id);
$data['product_downloadlink'] = $this->getDownloadlinks($product_id);
]]></add>
		</operation>

		<operation error="log">
			<search position="after" index="2"><![CDATA[
$this->db->query("DELETE FROM " . DB_PREFIX . "product_to_download WHERE product_id = '" . (int)$product_id . "'");
]]></search>
			<add><![CDATA[
$this->db->query("DELETE FROM " . DB_PREFIX . "serialkeys WHERE product_id = '" . (int)$product_id . "'");
		$this->db->query("DELETE FROM " . DB_PREFIX . "downloadlinks WHERE product_id = '" . (int)$product_id . "'");
]]></add>
		</operation>

		<operation error="log">
			<search position="before"><![CDATA[
public function getProductStores($product_id) {
]]></search>
			<add><![CDATA[
public function getSerialkeys($product_id) {
		$serialkey_data = array();

		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_to_serial WHERE product_id = '" . (int)$product_id . "'");

		foreach ($query->rows as $result) {
			$serialkey_data[] = $result['serial_id'];
		}
		return $serialkey_data;
	}

	public function getDownloadlinks($product_id) {
		$downloadlink_data = array();

		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_to_downloadlink WHERE product_id = '" . (int)$product_id . "'");

		foreach ($query->rows as $result) {
			$downloadlink_data[] = $result['downloadlink_id'];
		}

		return $downloadlink_data;
	}

	public function getProductSerialkeys($product_id) {
		$serialkeys_data = array();

		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "serialkeys WHERE product_id = '" . (int)$product_id . "' ORDER BY serial_id");

		foreach ($query->rows as $result) {
			$serialkeys_data[] = $result['serialkey'];
		}

		return $serialkeys_data;
	}

	public function getProductDownloadlinks($product_id) {
		$downloadlinks_data = array();

		$this->load->model('localisation/language');
		$languages = $this->model_localisation_language->getLanguages();

		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "downloadlinks WHERE product_id = '" . (int)$product_id . "' ORDER BY downloadlink_id");
		$downloadlinks_data = array();
		foreach ($languages as $language) {
			$downloadlinks_data[$language['language_id']]="";
		}
		foreach ($query->rows as $result) {
			$downloadlinks_data[$result['language_id']] = $result['downloadlink'];
		}

		return $downloadlinks_data;
	}
	public function getProductArticles($product_id) {


		$this->load->model('localisation/language');
		$languages = $this->model_localisation_language->getLanguages();

		$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_article WHERE product_id = '" . (int)$product_id . "'");
		$articles_data = 0;

		foreach ($query->rows as $result) {
			$articles_data = $result['article_id'];
		}

		return $articles_data;
	}
]]></add>
		</operation>

		<operation error="log">
			<search position="before"><![CDATA[
public function getTotalProductsByManufacturerId($manufacturer_id) {
]]></search>
			<add><![CDATA[
public function getTotalProductsBySerialId($serial_id) {
		$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "serialkeys WHERE serial_id = '" . (int)$serial_id . "'");

		return $query->row['total'];
	}

	public function getTotalProductsByDownloadlinkId($downloadlink_id) {
		$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "downloadlinks WHERE downloadlink_id = '" . (int)$downloadlink_id . "'");

		return $query->row['total'];
	}
]]></add>
		</operation>
	</file>
	<file name="admin/language/*/catalog/product.php">
		<operation error="log">
			<search position="before"><![CDATA[
			$_['entry_meta_description']
			]]></search>
			<add><![CDATA[
			$_['entry_serialkey'] 	 = 'Serial Keys:';
$_['entry_sell_serialkeyword'] 	 = 'Would you like to sell serial keys?';
$_['entry_downloadlink']     = 'Download links:';
$_['entry_article']     = 'Article:';
			]]></add>
		</operation>
	</file>
	<file name="admin/controller/catalog/product.php">
		<operation error="log">
			<search position="before"><![CDATA[
			if (isset($this->request->get['page']))
			]]></search>
			<add><![CDATA[
			if (isset($this->request->get['saleserials'])) {
				$url .= '&saleserials=' . $this->request->get['saleserials'];
			}

			if (isset($this->request->get['saledownloadlinks'])) {
				$url .= '&saledownloadlinks=' . $this->request->get['saledownloadlinks'];
			}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
			$data['entry_description']
			]]></search>
			<add><![CDATA[
			$data['entry_serialkey'] = $this->language->get('entry_serialkey');
		$data['entry_downloadlink'] = $this->language->get('entry_downloadlink');
		$data['entry_article'] = $this->language->get('entry_article');
		$data['entry_sell_serialkeyword'] = $this->language->get('entry_sell_serialkeyword');
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
			$data['entry_description'] = $this->language->get('entry_description');
			]]></search>
			<add><![CDATA[
			$data['entry_serialkey'] = $this->language->get('entry_serialkey');
		$data['entry_downloadlink'] = $this->language->get('entry_downloadlink');
		$data['entry_article'] = $this->language->get('entry_article');
		$data['entry_sell_serialkeyword'] = $this->language->get('entry_sell_serialkeyword');
			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[
			if (isset($this->request->post['image']))
			]]></search>
			<add><![CDATA[
			if (isset($this->request->post['saleserials'])) {
			$data['saleserials'] = $this->request->post['saleserials'];
		} elseif (!empty($product_info)) {
			$data['saleserials'] = $product_info['saleserials'];
		} else {
			$data['saleserials'] = 'N';
		}

		if (isset($this->request->post['saledownloadlinks'])) {
			$data['saledownloadlinks'] = $this->request->post['saledownloadlinks'];
		} elseif (!empty($product_info)) {
			$data['saledownloadlinks'] = $product_info['saledownloadlinks'];
		} else {
			$data['saledownloadlinks'] = 'N';
		}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
			$data['product_download'] = array();
			]]></search>
			<add><![CDATA[
		}
		if (isset($this->request->post['serialkey'])) {
			$data['serialkey'] = $this->request->post['serialkey'];
		} elseif (isset($this->request->get['product_id'])) {
			$data['serialkey'] = implode("\n",$this->model_catalog_product->getProductSerialkeys($this->request->get['product_id']));
		} else {
			$data['serialkey'] = '';
		}

		$this->load->model("catalog/information");
		if (isset($this->request->post['article'])) {
			$data['article'] = $this->request->post['article'];
			$art_desc = $this->model_catalog_information->getInformationDescriptions($data['article']);
			if(isset($art_desc[(int)$this->config->get('config_language_id')])){
				$data['article_name'] = $art_desc[(int)$this->config->get('config_language_id')]['title'];
			}else{
				$data['article_name'] = '';
			}
		} elseif (isset($this->request->get['product_id'])) {
			$data['article'] =  $this->model_catalog_product->getProductArticles($this->request->get['product_id']);
			$art_desc = $this->model_catalog_information->getInformationDescriptions($data['article']);
			if(isset($art_desc[(int)$this->config->get('config_language_id')])){
				$data['article_name'] = $art_desc[(int)$this->config->get('config_language_id')]['title'];
			}else{
				$data['article_name'] = '';
			}

		} else {
			$data['article'] = '0';
			$data['article_name'] = '';
		}

		$data['autolink'] = html_entity_decode($this->url->link('catalog/information/autocomplete', 'token=' . $this->session->data['token'], 'SSL'));


		if (isset($this->request->post['downloadlink'])) {
			$data['downloadlink'] = $this->request->post['downloadlink'];
		} elseif (isset($this->request->get['product_id'])) {
			$data['downloadlink'] = $this->model_catalog_product->getProductDownloadlinks($this->request->get['product_id']);
		} else {
			$data['downloadlink'] = array();
			foreach($data['languages'] as $lang){

				$data['downloadlink'][$lang['language_id']] = '';
			}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
			$product_downloads = array();
			]]></search>
			<add><![CDATA[
			}
		if (isset($this->request->post['serialkey'])) {
			$data['serialkey'] = $this->request->post['serialkey'];
		} elseif (isset($this->request->get['product_id'])) {
			$data['serialkey'] = implode("\n",$this->model_catalog_product->getProductSerialkeys($this->request->get['product_id']));
		} else {
			$data['serialkey'] = '';
		}

		$this->load->model("catalog/information");
		if (isset($this->request->post['article'])) {
			$data['article'] = $this->request->post['article'];
			$art_desc = $this->model_catalog_information->getInformationDescriptions($data['article']);
			if(isset($art_desc[(int)$this->config->get('config_language_id')])){
				$data['article_name'] = $art_desc[(int)$this->config->get('config_language_id')]['title'];
			}else{
				$data['article_name'] = '';
			}
		} elseif (isset($this->request->get['product_id'])) {
			$data['article'] =  $this->model_catalog_product->getProductArticles($this->request->get['product_id']);
			$art_desc = $this->model_catalog_information->getInformationDescriptions($data['article']);
			if(isset($art_desc[(int)$this->config->get('config_language_id')])){
				$data['article_name'] = $art_desc[(int)$this->config->get('config_language_id')]['title'];
			}else{
				$data['article_name'] = '';
			}

		} else {
			$data['article'] = '0';
			$data['article_name'] = '';
		}

		$data['autolink'] = html_entity_decode($this->url->link('catalog/information/autocomplete', 'token=' . $this->session->data['token'], 'SSL'));


		if (isset($this->request->post['downloadlink'])) {
			$data['downloadlink'] = $this->request->post['downloadlink'];
		} elseif (isset($this->request->get['product_id'])) {
			$data['downloadlink'] = $this->model_catalog_product->getProductDownloadlinks($this->request->get['product_id']);
		} else {
			$data['downloadlink'] = array();
			foreach($data['languages'] as $lang){

				$data['downloadlink'][$lang['language_id']] = '';
			}
			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[if ((utf8_strlen($this->request->post['model']) < 1) || (utf8_strlen($this->request->post['model']) > 64)) {]]></search>
			<add><![CDATA[
				if ($this->request->post['downloadlink']) {
					$flag_all_empty=true;
					foreach($this->request->post['downloadlink'] as $ind=>$link){
						if($link==""){
							$error['downloadlink'][$ind] = "All or no one downloadlinks must be set";
						}else{
							$flag_all_empty=false;
						}
					}
					if($flag_all_empty){
						unset($error['downloadlink']);
					}

				}
			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[if (isset($this->error['warning'])) {]]></search>
			<add><![CDATA[
				if (isset($this->error['downloadlink'])) {
					$data['error_downloadlink'] = $this->error['downloadlink'];
				} else {
					$data['error_downloadlink'] = Array();
				}

			]]></add>
		</operation>
		<operation error="log">
			<search position="after"><![CDATA[protected function getList() {]]></search>
			<add><![CDATA[$this->checkSerialkeysTables();]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[public function autocomplete]]></search>
			<add><![CDATA[
			private function checkSerialkeysTables() {
        // New Installation
        $query = $this->db->query("SHOW TABLES LIKE '" . DB_PREFIX . "serialkeys'");

        if (!$query->num_rows) {
            $this->db->query("CREATE TABLE IF NOT EXISTS `" . DB_PREFIX . "downloadlinks` (`downloadlink_id` int(11) NOT NULL AUTO_INCREMENT, `downloadlink` varchar(128) COLLATE utf8_bin NOT NULL DEFAULT '', `product_id` int(11) NOT NULL, `order_id` int(11) NOT NULL, `order_status_id` int(1) NOT NULL, `language_id` int(11) NOT NULL, `date_added` datetime NOT NULL DEFAULT '0000-00-00 00:00:00', PRIMARY KEY (`downloadlink_id`));");
        	$this->db->query("CREATE TABLE `" . DB_PREFIX . "order_downloadlink` (`order_downloadlink_id` int(11) NOT NULL AUTO_INCREMENT, `order_id` int(11) NOT NULL, `order_product_id` int(11) NOT NULL, `productname` varchar(64) COLLATE utf8_bin NOT NULL DEFAULT '', `downloadlink` varchar(128) COLLATE utf8_bin NOT NULL, `mask` varchar(128) COLLATE utf8_bin NOT NULL DEFAULT '', `remaining` int(3) NOT NULL DEFAULT '0',`language_id` int(11) NOT NULL, PRIMARY KEY (`order_downloadlink_id`));");
			$this->db->query("CREATE TABLE `" . DB_PREFIX . "order_serialkey` (`order_serialkey_id` int(11) NOT NULL AUTO_INCREMENT, `order_id` int(11) NOT NULL, `order_product_id` int(11) NOT NULL, `productname` varchar(64) COLLATE utf8_bin NOT NULL DEFAULT '', `serialkey` varchar(128) COLLATE utf8_bin NOT NULL, `mask` varchar(128) COLLATE utf8_bin NOT NULL DEFAULT '', `remaining` int(3) NOT NULL DEFAULT '0', PRIMARY KEY (`order_serialkey_id`));");
			$this->db->query("CREATE TABLE `" . DB_PREFIX . "product_to_downloadlink` (`product_id` int(11) NOT NULL, `downloadlink_id` int(11) NOT NULL, PRIMARY KEY (`product_id`,`downloadlink_id`));");
			$this->db->query("CREATE TABLE `" . DB_PREFIX . "product_to_serial` (`product_id` int(11) NOT NULL, `serial_id` int(11) NOT NULL, PRIMARY KEY (`product_id`,`serial_id`));");
			$this->db->query("CREATE TABLE `" . DB_PREFIX . "serialkeys` (`serial_id` int(11) NOT NULL AUTO_INCREMENT, `serialkey` varchar(128) COLLATE utf8_bin NOT NULL DEFAULT '', `product_id` int(11) NOT NULL, `order_id` int(11) NOT NULL, `order_status_id` int(1) NOT NULL, `date_added` datetime NOT NULL DEFAULT '0000-00-00 00:00:00', PRIMARY KEY (`serial_id`));");
			$this->db->query("ALTER TABLE `" . DB_PREFIX . "product` ADD	`saleserials` varchar(1) COLLATE utf8_bin NOT NULL DEFAULT 'N';");
			$this->db->query("ALTER TABLE `" . DB_PREFIX . "product` ADD	`saledownloadlinks` varchar(1) COLLATE utf8_bin NOT NULL DEFAULT 'N';");
		}
		$query = $this->db->query("SHOW TABLES LIKE '" . DB_PREFIX . "product_article'");
		if (!$query->num_rows) {
			$this->db->query("CREATE TABLE `" . DB_PREFIX . "product_article` (`product_article_id` int(11) NOT NULL AUTO_INCREMENT, `product_id` int(11) NOT NULL, `article_id` int(11) NOT NULL, PRIMARY KEY (`product_article_id`));");
		}
    }
			]]></add>
		</operation>
	</file>
	<file name="admin/view/template/catalog/product_form.tpl">
		<operation error="log">
			<search position="before"><![CDATA[
                <label class="col-sm-2 control-label" for="input-date-available"><?php echo $entry_date_available; ?></label>]]></search>
			<add><![CDATA[

				<label class="col-sm-2 control-label" for="saleserials"><?php echo $entry_sell_serialkeyword; ?></label>
                <div class="col-sm-10">
                    <input  class="form-control" onclick="showBox(this)" type="checkbox" name="saleserials" id="saleserials" value="Y" <?php echo ($saleserials=="Y" ? 'checked="checked"' : '')?> />
					<textarea class="form-control" name="serialkey" cols="100" rows="5" id="sk" style="display:none"><?php echo $serialkey; ?></textarea>
                </div>
			</div>


                <script type="text/javascript">
                selectbox = document.getElementById('subtract');
				checkbox = document.getElementById('saleserials');

				function showBox(elem){
                document.getElementById("sk").style.display=elem.checked?"block":"none";
                }
				showBox(document.getElementById("saleserials"));

				checkbox.addEventListener('change', function() {
					selectbox.value = "1"
				});

				$(checkbox).change(function(){

                $(selectbox).prop('disabled', true);

 				 });

                </script>
		    <div class="form-group">
                <label class="col-sm-2 control-label" for="saledownloadlinks"><?php echo $entry_downloadlink; ?></label>
                <div class="col-sm-10">
					<input class="form-control" onclick="showBox2(this)" type="checkbox" name="saledownloadlinks" id="saledownloadlinks" value="Y" <?php echo ($saledownloadlinks=="Y" ? 'checked="checked"' : '')?> />
					<p></p>
					<?php foreach ($languages as $language) { ?>

							<div id="dk<?php echo $language['language_id']; ?>" class="input-group"><span class="input-group-addon"><img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" /></span>
								<input class="form-control"  name="downloadlink[<?php echo $language['language_id']; ?>]" value="<?php echo $downloadlink[$language['language_id']]; ?>" ></input>

							</div>
							<?php if (isset($error_downloadlink[$language['language_id']])) { ?>
								<div class="text-danger"><?php echo $error_downloadlink[$language['language_id']]; ?></div>
							<?php } ?>
							<p></p>

					<?php } ?>
							<p></p>
							<div id="ak" class="input-group"><div class="input-group-addon">?</div>
								<input class="form-control" id="article_name" name="article_name" value="<?php echo $article_name; ?>" ></input>

							</div>
							<input class="hidden" id="article_id" name="article" value="<?php echo $article; ?>" ></input>

				</div>

                <script type="text/javascript">


				$(function(){

				    $('#article_name').on('change', function(){
					    $("#article_id").val(0);
					});

					$('#article_name').autocomplete({
						'source': function(request, response) {
							$.ajax({
								url: '<?php echo $autolink; ?>&like=' +  encodeURIComponent(request),
								dataType: 'json',
								success: function(json) {

									response($.map(json, function(item) {
										return {
											label: item['title'],
											value: item['information_id']
										}
									}));
								}
							});
						},
						'select': function(item) {
							$("#article_id").val(item['value']);
							$("#article_name").val(item['label']);
						}
					});

				})



                function showBox2(elem){
					<?php foreach ($languages as $language) { ?>
					document.getElementById("dk<?php echo $language['language_id']; ?>").style.display=elem.checked?"table":"none";

					<?php } ?>
					document.getElementById("ak").style.display=elem.checked?"table":"none";
                }
		showBox2(document.getElementById("saledownloadlinks"));
                </script>

			</div>
			<div class="form-group">
			]]></add>
		</operation>
	</file>
	<!-- PRODUCT EDIT END -->
	<!-- ORDER LIST EDIT -->
	<file name="admin/view/template/sale/order_list.tpl">
		<operation>
			<search position="after"><![CDATA[
        <div id="content">
		]]></search>
			<add><![CDATA[
		<div class="modal fade bs-example-modal-sm" tabindex="-1" id="mymodal" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
            <div class="modal-content">
            <div class="modal-header">
            Return keys from selected orders to products?
            <button class="close" aria-hidden="true" data-dismiss="modal" type="button" style="position:absolute; top:5px;right:5px;">×</button>
            </div>
            <div class="modal-body" style="min-height:70px;">
            <button id="button-history-y" data-loading-text="<?php echo $text_loading; ?>" class="btn btn-primary btn-lg" aria-hidden="true" data-dismiss="modal" Style="position:absolute;left:20%;">YES</button>
            <button id="button-history-n" data-loading-text="<?php echo $text_loading; ?>" class="btn btn-primary btn-lg" aria-hidden="true" data-dismiss="modal" Style="position:absolute;right:20%">NO</button>
            </div>
            </div>
            </div>
            </div>
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
        if (confirm('<?php echo $text_confirm; ?>')) {
		]]></search>
			<add><![CDATA[
	node = this
	$('#mymodal').modal()
	}
	});
		$('#button-history-y').click(function() {
		if ( node != 0.5 ) {
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
        var node = this;
		]]></search>
			<add><![CDATA[
        //
]]></add>
		</operation>
		<operation>
			<search position="before" offset="3"><![CDATA[
        <script src="view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
		]]></search>
			<add><![CDATA[
        $("#form-order").load(location.href+" #form-order>*")
        ]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
        $('#button-filter').on('click', function() {
		]]></search>
			<add><![CDATA[
        $('#button-history-n').click(function() {

        serialdeletestatus = 1
			$.ajax({
		url: '<?php echo $store; ?>index.php?route=api/order/delete&token=' + token + '&order_id=' + $(node).val(),
		type: 'post',
		dataType: 'json',
		data: 'serialdeletestatus=' + serialdeletestatus
		})

           $.ajax({
			url: '<?php echo $store; ?>index.php?route=api/order/delete&token=' + token + '&order_id=' + $(node).val(),
			dataType: 'json',
			crossDomain: true,
			beforeSend: function() {
				$(node).button('loading');
			},
			complete: function() {
				$(node).button('reset');
			},
			success: function(json) {
				$('.alert').remove();

				if (json['error']) {
					$('#content > .container-fluid').prepend('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> ' + json['error'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');
				}

				if (json['success']) {
					$('#content > .container-fluid').prepend('<div class="alert alert-success"><i class="fa fa-check-circle"></i> ' + json['success'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');
				}
			},
			error: function(xhr, ajaxOptions, thrownError) {
				alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			}
		  });
		  $("#form-order").load(location.href+" #form-order>*")
        });
]]></add>
		</operation>

		<operation error="log">
			<search position="before"><![CDATA[$sort == 'o.date_added']]></search>
			<add><![CDATA[<td class="text-left">Product Name</td>
<td class="text-left">Serial Key</td>]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
$('button[id^=\'button-delete\']').on('click', function(e) {
		]]></search>
			<add><![CDATA[
$('body').on('click', 'button[id^=\'button-delete\']', function(){
        ]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[$order['date_added']]]></search>
			<add><![CDATA[<td class="text-left"><?php echo $order['productname']; ?></td>
<td class="text-left"><?php echo $order['serialkey']; ?></td>]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[colspan="8"]]></search>
			<add><![CDATA[colspan="10"]]></add>
		</operation>
	</file>

	<file name="catalog/controller/api/order.php">
		<operation>
			<search position="replace"><![CDATA[
            $this->model_checkout_order->addOrderHistory($order_id, $this->request->post['order_status_id'], $this->request->post['comment'], $this->request->post['notify'], $this->request->post['override']);
			]]></search>
			<add><![CDATA[
			if ( empty($this->request->post['serialdeletestatus']) ) {
			$this->model_checkout_order->addOrderHistory($order_id, $this->request->post['order_status_id'], $this->request->post['comment'], $this->request->post['notify'], $this->request->post['override']);
			}
			else
			{
			$this->model_checkout_order->addOrderHistory($order_id, $this->request->post['order_status_id'], $this->request->post['comment'], $this->request->post['notify'], $this->request->post['override'], 1);
			}
            ]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
            $this->model_checkout_order->addOrderHistory($json['order_id'], $order_status_id);
			]]></search>
			<add><![CDATA[
			if ( !isset($this->request->post['reward']) ) {
			$this->model_checkout_order->addOrderHistory($json['order_id'], $order_status_id);
			}
			else
			{
			$this->model_checkout_order->addOrderHistory($json['order_id'], $order_status_id, null, null , null, 1);
			}
            ]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
            $this->model_checkout_order->addOrderHistory($order_id, $order_status_id);
			]]></search>
			<add><![CDATA[
			if ( !isset($this->request->post['reward']) ) {
			$this->model_checkout_order->addOrderHistory($order_id, $order_status_id);
			}
			else
			{
			$this->model_checkout_order->addOrderHistory($order_id, $order_status_id, null, null, null, 1);
			}
            ]]></add>
		</operation>
	</file>

	<file name="admin/view/template/sale/order_form.tpl">
		<operation>
			<search position="after"><![CDATA[
            <div id="content">
			]]></search>
			<add><![CDATA[
            <div class="modal fade bs-example-modal-sm" tabindex="-1" id="mymodal" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
            <div class="modal-content">
            <div class="modal-header">
            Return keys from selected orders to products?
            <button class="close" aria-hidden="true" data-dismiss="modal" type="button">×</button>
            </div>
            <div class="modal-body" style="min-height:70px;">
            <button id="button-history-y" data-loading-text="<?php echo $text_loading; ?>" class="btn btn-primary btn-lg" aria-hidden="true" data-dismiss="modal" Style="position:absolute;left:20%;">YES</button>
            <button id="button-history-n" data-loading-text="<?php echo $text_loading; ?>" class="btn btn-primary btn-lg" aria-hidden="true" data-dismiss="modal" Style="position:absolute;right:20%">NO</button>
            </div>
            </div>
            </div>
            </div>
            ]]></add>
		</operation>
		<operation>
			<search position="replace" offset="6"><![CDATA[
            <?php foreach ($order_statuses as $order_status) { ?>
			]]></search>
			<add><![CDATA[
            <?php foreach ($order_statuses as $order_status) { ?>
            <?php if ($order_status['order_status_id'] == $order_status_id) { ?>
            <option value="<?php echo $order_status['order_status_id']; ?>" selected="selected" status="<?php if(in_array($order_status['order_status_id'], $statuses)) { echo 'yes';}?>"><?php echo $order_status['name']; ?></option>
            <?php } else { ?>
            <option value="<?php echo $order_status['order_status_id']; ?>" status="<?php if(in_array($order_status['order_status_id'], $statuses)) { echo 'yes';}?>"><?php echo $order_status['name']; ?></option>
            <?php } ?>
            <?php } ?>
            ]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
            $('#button-save').on('click', function() {
			]]></search>
			<add><![CDATA[
            if ( $('#input-order-status option:selected').attr('status') == "yes" )
			{
			buttonSave()
			}
			else {
            $('#mymodal').modal()
			}
			});
            function buttonSave()  {
            ]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
            $('#button-save').on('click', function() {
			]]></search>
			<add><![CDATA[
			$('#button-history-y').click(function() {
			buttonSave()
			})

			$('#button-history-n').click(function() {

            if ($('input[name=\'order_id\']').val() == 0) {
		var url = $('select[name=\'store\'] option:selected').val() + 'index.php?route=api/order/add&token=' + token;
	} else {
		var url = $('select[name=\'store\'] option:selected').val() + 'index.php?route=api/order/edit&token=' + token + '&order_id=' + $('input[name=\'order_id\']').val();
	}

	$.ajax({
		url: url,
		type: 'post',
		data: $('select[name=\'payment_method\'] option:selected,  select[name=\'shipping_method\'] option:selected,  #tab-total select[name=\'order_status_id\'], #tab-total select, #tab-total textarea[name=\'comment\'], #tab-total input[name=\'affiliate_id\'], input[name=\'reward\']'),
		dataType: 'json',
		crossDomain: true,
		beforeSend: function() {
			$('#button-save').button('loading');
		},
		complete: function() {
			$('#button-save').button('reset');
		},
		success: function(json) {
			$('.alert, .text-danger').remove();

			if (json['error']) {
				$('#content > .container-fluid').prepend('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> ' + json['error'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');
			}

			if (json['success']) {
				$('#content > .container-fluid').prepend('<div class="alert alert-success"><i class="fa fa-check-circle"></i> ' + json['success'] + '  <button type="button" class="close" data-dismiss="alert">&times;</button></div>');

                // Refresh products, vouchers and totals
				$('#button-refresh').trigger('click');
            }

			if (json['order_id']) {
				$('input[name=\'order_id\']').val(json['order_id']);
			}
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});
	})



            ]]></add>
		</operation>
		<operation>
			<search position="replace" offset="-2"><![CDATA[
            $('#content').delegate('button[id^=\'button-upload\'], button[id^=\'button-custom-field\'], button[id^=\'button-payment-custom-field\'], button[id^=\'button-shipping-custom-field\']', 'click', function() {
			]]></search>
			<add><![CDATA[
			}
            $('#content').delegate('button[id^=\'button-upload\'], button[id^=\'button-custom-field\'], button[id^=\'button-payment-custom-field\'], button[id^=\'button-shipping-custom-field\']', 'click', function() {
            ]]></add>
		</operation>
	</file>

	<file name="admin/view/template/sale/order_info.tpl">
		<operation>
			<search position="after"><![CDATA[
            <div id="content">
			]]></search>
			<add><![CDATA[
            <div class="modal fade bs-example-modal-sm" tabindex="-1" id="mymodal" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
            <div class="modal-content">
            <div class="modal-header">
            Return keys from selected orders to products?
            <button class="close" aria-hidden="true" data-dismiss="modal" type="button" style="position:absolute; top:5px;right:5px;">×</button>
            </div>
            <div class="modal-body" style="min-height:70px;">
            <button id="button-history-y" data-loading-text="<?php echo $text_loading; ?>" class="btn btn-primary btn-lg" aria-hidden="true" data-dismiss="modal" Style="position:absolute;left:20%;">YES</button>
            <button id="button-history-n" data-loading-text="<?php echo $text_loading; ?>" class="btn btn-primary btn-lg" aria-hidden="true" data-dismiss="modal" Style="position:absolute;right:20%">NO</button>
            </div>
            </div>
            </div>
            </div>
            ]]></add>
		</operation>
		<operation>
			<search position="replace" offset="6"><![CDATA[
            <?php foreach ($order_statuses as $order_statuses) { ?>
			]]></search>
			<add><![CDATA[
              <?php foreach ($order_statuses as $order_statuses) { ?>
                      <?php if ($order_statuses['order_status_id'] == $order_status_id) { ?>
                      <option value="<?php echo $order_statuses['order_status_id']; ?>" selected="selected" status="<?php if(in_array($order_statuses['order_status_id'], $statuses)) { echo 'yes';}?>"><?php echo $order_statuses['name']; ?></option>
                      <?php } else { ?>
                      <option value="<?php echo $order_statuses['order_status_id']; ?>" status="<?php if(in_array($order_statuses['order_status_id'], $statuses)) { echo 'yes';}?>"><?php echo $order_statuses['name']; ?></option>
                      <?php } ?>
                      <?php } ?>
            ]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
            $('#button-history').on('click', function() {
			]]></search>
			<add><![CDATA[
			$('#button-history-y').click(function() {
			buttonHistory()
			})

			$('#button-history-n').click(function() {
            serialdeletestatus = 1
			$.ajax({
		url: '<?php echo $store_url; ?>index.php?route=api/order/history&token=' + token + '&order_id=<?php echo $order_id; ?>',
		type: 'post',
		dataType: 'json',
		data: 'serialdeletestatus=' + serialdeletestatus + '&order_status_id=' + encodeURIComponent($('select[name=\'order_status_id\']').val()) + '&notify=' + ($('input[name=\'notify\']').prop('checked') ? 1 : 0) + '&override=' + ($('input[name=\'override\']').prop('checked') ? 1 : 0) + '&append=' + ($('input[name=\'append\']').prop('checked') ? 1 : 0) + '&comment=' + encodeURIComponent($('textarea[name=\'comment\']').val()),
		beforeSend: function() {
			$('#button-history').button('loading');
		},
		complete: function() {
			$('#button-history').button('reset');
		},
		success: function(json) {
			$('.alert').remove();

			if (json['error']) {
				$('#history').before('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> ' + json['error'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');
			}

			if (json['success']) {
				$('#history').load('index.php?route=sale/order/history&token=<?php echo $token; ?>&order_id=<?php echo $order_id; ?>');

				$('#history').before('<div class="alert alert-success"><i class="fa fa-check-circle"></i> ' + json['success'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');

				$('textarea[name=\'comment\']').val('');
			}
		},
		error: function(xhr, ajaxOptions, thrownError) {
			alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
		}
	});


			})
            ]]></add>
		</operation>
		<operation>
			<search position="after" offset="9"><![CDATA[
            $('#button-history').on('click', function() {
			]]></search>
			<add><![CDATA[
			if ( $('#input-order-status option:selected').attr('status') == "yes" )
			{
			buttonHistory()
			}
			else {
            $('#mymodal').modal()
			}
			});
            function buttonHistory() {
            ]]></add>
		</operation>
		<operation>
			<search position="replace" offset="-2"><![CDATA[
            function changeStatus(){
			]]></search>
			<add><![CDATA[
			}
            function changeStatus(){
            ]]></add>
		</operation>
	</file>

	<file name="admin/controller/sale/order.php">
		<operation>
			<search position="after"><![CDATA[
            $data['breadcrumbs'] = array();
			]]></search>
			<add><![CDATA[
            $data['statuses'] = array_merge($this->config->get('config_processing_status'), $this->config->get('config_complete_status'));
            ]]></add>
		</operation>
		<operation>
			<search position="before" index="1" ><![CDATA[$data['heading_title'] = $this->language->get('heading_title');]]></search>
			<add><![CDATA[

		$this->load->model('sale/serial_keys');

    	for($i=0;$i<count($data['orders']);$i++) {


			$getkeys = $this->model_sale_serial_keys->getSerialkeys($data['orders'][$i]['order_id']);
			$serialkeys = array();
			$productnames = array();
			foreach ($getkeys as $serialkey) {
				$serialkeys[]= $serialkey['serialkey'];
				$productnames[]= $serialkey['productname'];
			}
			$serialkeys = implode('<br />',$serialkeys);
			$productnames = implode('<br />',$productnames);
			$data['orders'][$i]['serialkey'] = $serialkeys;
			$data['orders'][$i]['productname'] = $productnames;

		}
]]></add>
		</operation>
	</file>
	<!-- ORDER LIST EDIT END -->
	<!-- ADMIN MODS END -->
	<!-- FRONT MODS -->
	<!-- ACCOUNT PAGE EDIT -->
	<file name="catalog/view/theme/*/template/account/account.tpl">
		<operation error="log">
			<search position="before"><![CDATA[
			<li><a href="<?php echo $order; ?>">
			]]></search>
			<add><![CDATA[
			<li><a href="<?php echo $serial_keys; ?>"><?php echo $text_serial_keys; ?></a></li>
			]]></add>
		</operation>
	</file>
	<file name="catalog/language/*/account/account.php">
		<operation error="log">
			<search position="before"><![CDATA[
			$_['text_download']
			]]></search>
			<add><![CDATA[
			$_['text_serial_keys']   = 'My downloaded products Serial Keys';
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/account/account.php">
		<operation error="log">
			<search position="before"><![CDATA[
			$data['text_reward']
			]]></search>
			<add><![CDATA[
			$data['text_serial_keys'] = $this->language->get('text_serial_keys');
			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[
			$data['return']
			]]></search>
			<add><![CDATA[
			$data['serial_keys'] = $this->url->link('account/serial_keys', '', 'SSL');
		$data['downloadlink'] = $this->url->link('account/serial_keys', '', 'SSL');
			]]></add>
		</operation>
	</file>
	<!-- ACCOUNT PAGE EDIT END -->
	<!-- ACCOUNT MODULE EDIT -->
	<file name="catalog/controller/module/account.php">
		<operation error="log">
			<search position="after"><![CDATA[
			$data['text_account'] = $this->language->get('text_account');
			]]></search>
			<add><![CDATA[
			$data['text_serialkeys'] = $this->language->get('text_serialkeys');
			]]></add>
		</operation>
		<operation error="log">
			<search position="after"><![CDATA[
			$data['account'] = $this->url->link('account/account', '', 'SSL');
			]]></search>
			<add><![CDATA[
			$data['serialkeys'] = $this->url->link('account/serial_keys', '', 'SSL');
			]]></add>
		</operation>
	</file>
	<file name="catalog/language/*/module/account.php">
		<operation error="log">
			<search position="before"><![CDATA[
			$_['text_edit']
			]]></search>
			<add><![CDATA[
			/* RESTRICTED SHOPPING */
$_['text_serialkeys']  = 'My Codes';
/* RESTRICTED SHOPPING END */
			]]></add>
		</operation>
	</file>
	<file name="catalog/view/theme/*/template/module/account.tpl">
		<operation error="log">
			<search position="after"><![CDATA[
			 <a href="<?php echo $account; ?>" class="list-group-item"><?php echo $text_account; ?></a>
			]]></search>
			<add><![CDATA[
 <a href="<?php echo $serialkeys; ?>" class="list-group-item"><?php echo $text_serialkeys; ?></a>
			]]></add>
		</operation>
	</file>
	<!-- ACCOUNT MODULE EDIT END -->
	<!-- SUCCESS EDIT -->
	<file name="catalog/controller/checkout/success.php">
		<operation error="log">
			<search position="replace"><![CDATA[
			$data['text_message'] = sprintf($this->language->get('text_customer'), $this->url->link('account/account', '', 'SSL'), $this->url->link('account/order', '', 'SSL'), $this->url->link('account/download', '', 'SSL'), $this->url->link('information/contact'));
			]]></search>
			<add><![CDATA[
			$data['text_message'] = sprintf($this->language->get('text_customer2'), $this->url->link('account/account', '', 'SSL'), $this->url->link('account/order', '', 'SSL'), $this->url->link('account/download', '', 'SSL'), $this->url->link('account/order', '', 'SSL'), $this->url->link('account/serial_keys', '', 'SSL'),$this->url->link('information/contact'));
			]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[text_guest]]></search>
			<add><![CDATA[text_guest2]]></add>
		</operation>
	</file>
	<file name="catalog/language/*/checkout/success.php">
		<operation error="log">
			<search position="before"><![CDATA[$_['text_customer']]]></search>
			<add><![CDATA[
			$_['text_customer2']        = '<h3>Your order has been successfully processed!</h3>A email containing your code is sent to you. You can also find your code by using this link: <a href="index.php?route=account/serial_keys">My Codes</a> <br><br> <p>You can view your order history by going to the <a href="%s">my account</a> page and by clicking on <a href="%s">history</a>.</p><p>Thanks for shopping with us online!</p>';
			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[$_['text_guest']]]></search>
			<add><![CDATA[
			$_['text_guest2']    = '<h3>Your order has been successfully processed!</h3>
						<p>A email containing your <b>code is sent to you</b>, please check your spam folder before contacting us with question regarding the delivery of the product.</p>
									<p>Please direct any questions you have to the <a href="%s">store owner</a>.</p>
					    <p>Thanks for shopping with us online!</p>';
			]]></add>
		</operation>
	</file>
	<!-- SUCCESS EDIT END -->
	<!-- CHECKOUT ORDER EDIT -->
	<file name="catalog/model/checkout/order.php">
		<!-- EMAIL KEY TO A CUSTOMER -->

		<operation>
			<search position="replace"><![CDATA[
			public function addOrderHistory($order_id, $order_status_id, $comment = '', $notify = false, $override = false) {
			]]></search>
			<add><![CDATA[
			public function addOrderHistory($order_id, $order_status_id, $comment = '', $notify = false, $override = false, $serialdeletestatus = false) {
			]]></add>
		</operation>

		<!--<operation>
			<search position="after"><![CDATA[
            $text .= $language->get('text_new_footer') . "\n\n";
			]]></search>
			<add><![CDATA[
			if (  ) {
			]]></add>
		</operation>

		<operation>
			<search position="before" offset="2"><![CDATA[
            if ($this->config->get('config_order_mail')) {
			]]></search>
			<add><![CDATA[
            }
			]]></add>
		</operation>-->

		<operation error="log">
			<search position="before" index="1"><![CDATA[if ($comment && $notify)]]></search>
			<add><![CDATA[

			if ($order_status_id == $this->config->get('config_complete_status')[0]) {

				$message .= $language->get('text_new_link2') . "\n";
				$message .= html_entity_decode($order_info['store_url'] . 'index.php?route=account/serial_keys', ENT_QUOTES, 'UTF-8') . "\n\n";

				$query = $this->db->query("SELECT serialkey FROM ".DB_PREFIX."order_serialkey
												WHERE order_id = ".$order_id);
				if ($query->num_rows) {
					foreach ($query->rows as $row)
						{
							$message .= "Your pin: ".strip_tags(html_entity_decode($row['serialkey'], ENT_QUOTES, 'UTF-8')) . "\n";
						}
					}
				}
			]]></add>
		</operation>
		<!-- EMAIL KEY TO A CUSTOMER END -->
		<operation error="log">
			<search position="replace" index="1"><![CDATA[
			$order_product_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_product WHERE order_id = '" . (int)$order_id . "'");
			]]></search>
			<add><![CDATA[
			$order_product_query = $this->db->query("SELECT o.*, pd.language_id FROM " . DB_PREFIX . "order_product AS o LEFT JOIN " . DB_PREFIX . "product_description as pd on o.product_id = pd.product_id WHERE o.order_id = '" . (int)$order_id . "' GROUP BY o.product_id");
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			if (!in_array($order_info['order_status_id'], array_merge($this->config->get('config_processing_status'), $this->config->get('config_complete_status'))) && in_array($order_status_id, array_merge($this->config->get('config_processing_status'), $this->config->get('config_complete_status')))) {
			]]></search>
			<add><![CDATA[
			if (/*!in_array($order_info['order_status_id'], array_merge($this->config->get('config_processing_status'), $this->config->get('config_complete_status'))) &&*/ in_array($order_status_id, array_merge($this->config->get('config_processing_status'), $this->config->get('config_complete_status')))) {
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
            if (in_array($order_info['order_status_id'], array_merge($this->config->get('config_processing_status'), $this->config->get('config_complete_status'))) && !in_array($order_status_id, array_merge($this->config->get('config_processing_status'), $this->config->get('config_complete_status')))) {
			]]></search>
			<add><![CDATA[
			if (/*in_array($order_info['order_status_id'], array_merge($this->config->get('config_processing_status'), $this->config->get('config_complete_status'))) &&*/ !in_array($order_status_id, array_merge($this->config->get('config_processing_status'), $this->config->get('config_complete_status')))) {
			]]></add>
		</operation>

		<operation error="log">
			<search position="after" index="1" offset="2"><![CDATA[
			foreach ($order_option_query->rows as $option)
			]]></search>
			<add><![CDATA[
				// serialkeys
				$order_product_serials_query = $this->db->query("SELECT pd.name, p.product_id, s.serial_id, s.serialkey FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "serialkeys s ON s.product_id = p.product_id LEFT JOIN " . DB_PREFIX . "product_description pd ON s.product_id = pd.product_id WHERE p.product_id = '" . (int)$order_product['product_id'] . "'  AND pd.language_id = '" . (int)$order_info['language_id'] . "' AND p.saleserials ='Y' ORDER BY s.serial_id");

				// downloadlinks
				$order_product_downloadlinks_query = $this->db->query("SELECT pd.name, p.product_id, d.downloadlink_id, d.downloadlink AS downloadlink, d.language_id FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "downloadlinks d ON d.product_id=p.product_id LEFT JOIN " . DB_PREFIX . "product_description pd ON d.product_id=pd.product_id WHERE p.product_id = '" . (int)$order_product['product_id'] . "' AND p.saledownloadlinks='Y'  AND pd.language_id = d.language_id ORDER BY d.downloadlink_id");

                $order_serial_check = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_serialkey WHERE order_id='" . (int)$order_id . "' AND order_product_id='" . (int)$order_product['product_id'] . "'");

				if ($order_product_serials_query->num_rows) {
					$serials = $order_product_serials_query->rows;
					for ($i=0;$i<$order_product['quantity'];$i++) {
						// add key then delete it from all table

					   if ($order_serial_check->num_rows <= $i) {
						$this->db->query("INSERT INTO " . DB_PREFIX . "order_serialkey SET order_id = '" . (int)$order_id . "', order_product_id = '" . (int)$order_product['product_id'] . "', productname = '" . $this->db->escape($serials[$i]['name']) . "', serialkey = '" . $this->db->escape($serials[$i]['serialkey']) . "'");

						$this->db->query("DELETE FROM " . DB_PREFIX . "serialkeys WHERE serial_id='" . (int)$serials[$i]['serial_id'] . "'");
                       }
					}
                        $serials_product = $this->db->query("SELECT * FROM `" .  DB_PREFIX . "serialkeys` WHERE product_id='" . (int)$product_info['product_id'] . "'");

                        if ( $serials_product->num_rows ) {
						$fff = count($serials_product->rows);
                        }
						$this->db->query("UPDATE `" . DB_PREFIX . "product` SET quantity='" . (int)$fff . "' WHERE product_id='" . (int)$product_info['product_id'] . "'");

				}

				if ($order_product_downloadlinks_query->num_rows) {
					$downloadlinks = $order_product_downloadlinks_query->rows;

                    $this->db->query("DELETE FROM `" . DB_PREFIX . "order_downloadlink` WHERE order_id = '" . $order_id . "' AND order_product_id= '" . $order_product['product_id'] . "'");
						foreach($downloadlinks as $d)
						if(!empty($d['downloadlink'])) {
                                $this->db->query("INSERT INTO " . DB_PREFIX . "order_downloadlink SET order_id = '" . (int)$order_id . "', order_product_id = '" . (int)$order_product['product_id'] . "', productname = '" . $this->db->escape($d['name']) . "', downloadlink = '" . $this->db->escape($d['downloadlink']) . "', language_id = '" . $this->db->escape($d['language_id']) . "'");
                        }
				}

			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[
			// Redeem coupon, vouchers and reward points
			]]></search>
			<add><![CDATA[
            // Notify admin about out of stock
			$subject_text = 'Out of stock on products';
			$message_text = 'There is less than ' . $this->config->get('config_stock_notify') . ' items left of: <br />';
			$i = 1;
			$send_notify = false;

			$order_product_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "order_product` WHERE order_id = '" . (int)$order_id  . "'");

			if(!empty($order_product_query)/*->rows*/) {

			    foreach($order_product_query->rows as $product_info) {
			        $quantity_check = $this->db->query("SELECT quantity FROM `" . DB_PREFIX . "product` WHERE product_id='" . $product_info['product_id'] . "'");

			        if($quantity_check->row['quantity'] <= $this->config->get('config_stock_notify')) {
			            $product_info_aute[] = $product_info;
			        }
			    }

			    foreach($product_info_aute as $product_info_1) {
			        if(count($product_info_aute) > 1) {
			            $message_text .= $i . '. ' . $product_info_1['name'] . '<br />';
                            $i++;
			        } else {
			            $subject_text = 'Out of stock on: ' .  $product_info_1['name'];
                            $message_text .= $product_info_1['name'] . '<br />';
			        }
			        $send_notify = true;
			    }

			}

			if ($send_notify) {

                $this->load->model('setting/store');
                $this->load->language('mail/customer');

                $mail = new Mail();
                $mail->protocol = $this->config->get('config_mail_protocol');
                $mail->parameter = $this->config->get('config_mail_parameter');
                $mail->smtp_hostname = $this->config->get('config_mail_smtp_hostname');
                $mail->smtp_username = $this->config->get('config_mail_smtp_username');
                $mail->smtp_password = html_entity_decode($this->config->get('config_mail_smtp_password'), ENT_QUOTES, 'UTF-8');
                $mail->smtp_port = $this->config->get('config_mail_smtp_port');
                $mail->smtp_timeout = $this->config->get('config_mail_smtp_timeout');
                $mail->setTo($this->config->get('config_email'));
                $mail->setFrom($this->config->get('config_email'));
                $mail->setReplyTo($order_info['email']);
                $mail->setSender('Out stock Alert');
                $mail->setSubject($subject_text);
                $mail->setHtml($message_text);
                $mail->send();
            }
			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[
			// Remove coupon, vouchers and reward points history
			]]></search>
			<add><![CDATA[
			// Get serial keys from order
                $order_sk_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_serialkey WHERE order_id = '" . (int)$order_id . "'");

                // Insert serial keys back in order
                if ( empty($this->request->post['serialdeletestatus']) ) {
                 if ( !isset($this->request->post['reward']) ) {
                 foreach($order_sk_query->rows as $serial) {
                    $this->db->query("INSERT INTO `". DB_PREFIX ."serialkeys` SET product_id='" . (int)$serial['order_product_id'] . "', serialkey='" . $serial['serialkey'] . "'");
                 }
                }
               }
               $this->db->query("DELETE FROM `" .  DB_PREFIX . "serialkeys` WHERE serialkey=''");
               $serials_product = $this->db->query("SELECT * FROM `" .  DB_PREFIX . "serialkeys` WHERE product_id='" . (int)$product['product_id'] . "'");

               if ( $serials_product->num_rows)  {
               $fff = count($serials_product->rows);
               $this->db->query("UPDATE `" . DB_PREFIX . "product` SET quantity='" . (int)$fff . "' WHERE product_id='" . (int)$product['product_id'] . "'");
               }

                 // Delete serial from order
                $this->db->query("DELETE FROM `" . DB_PREFIX . "order_serialkey` WHERE order_id = '" . $order_id . "'");

                // Delete download links from order
                $this->db->query("DELETE FROM `" . DB_PREFIX . "order_downloadlink` WHERE order_id = '" . $order_id . "'");
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
            $this->addOrderHistory($order_id, 0);
			]]></search>
			<add><![CDATA[
            $this->addOrderHistory($order_id, 0, null, null, null, 2);
			]]></add>
		</operation>
		<operation error="log">
			<search position="after"><![CDATA[
			$this->cache->delete('product');
			]]></search>
			<add><![CDATA[
			// Serialkeys
			$order_sk_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_serialkey WHERE order_id = '" . (int)$order_id . "'");

			// Download links
			$order_dl_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_downloadlink WHERE order_id = '" . (int)$order_id . "'");

			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[
            $data['products'][] = array(
			]]></search>
			<add><![CDATA[
			foreach ($complete_status as $complete_stat) {
            if ($order_status == $complete_stat) {
			$code_info = $this->getInfo($product['product_id'],$order_id,$order_info['language_id']); }
			            }
			            if(empty($code_info)) {
			            $code_info = '';
			            }
			]]></add>
		</operation>
		<operation error="log">
			<search position="after"><![CDATA[
			'model'    => $product['model'],
			]]></search>
			<add><![CDATA[

			'information'    =>  $code_info,

			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
                 if (!$order_info['order_status_id'] && $order_status_id) {
			]]></search>
			<add><![CDATA[
                 if (/*!$order_info['order_status_id'] && */$order_status_id) {
			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[
			public function addOrder($data) {
			]]></search>
			<add><![CDATA[
			public function getInfo($product_id,$order_id,$language_id){

				$serial_keys = $this->db->query("SELECT serialkey FROM " . DB_PREFIX . "order_serialkey WHERE order_id = '" . (int)$order_id . "' AND order_product_id = '".(int)$product_id."'");
				$str_serial_keys="";
				$i=1;
				foreach($serial_keys->rows as $s){
					$str_serial_keys.="Key/Code #".$i.":<br>".$s['serialkey']."<br>";
					$i++;
				}

				$downloadlinks = $this->db->query("SELECT downloadlink FROM " . DB_PREFIX . "order_downloadlink WHERE order_id = '" . (int)$order_id . "' AND order_product_id = '".(int)$product_id."' AND language_id='".(int)$language_id."'");
				$str_downloadlinks="";

				if($downloadlinks->rows) {
				foreach($downloadlinks->rows as $s){
					$str_downloadlinks.='Download link:<br><a href="'.$s['downloadlink'].'">'.$s['downloadlink'].'</a><br>';
				}
				}

				$articles = $this->db->query("SELECT pa.article_id, dd.title FROM " . DB_PREFIX . "product_article pa LEFT JOIN " . DB_PREFIX . "information_description dd ON pa.article_id=dd.information_id WHERE pa.product_id = '".(int)$product_id."' AND dd.language_id = '".$language_id."'");
				$str_articles="";
				foreach($articles->rows as $s){
					$link=$this->url->link('information/information', 'information_id=' . $s['article_id'], 'SSL');
					$str_articles.='Download instruction:<br><a href="'.$link.'">'.$s['title'].'</a><br>';
				}



				return $str_serial_keys.$str_downloadlinks.$str_articles;
			}
			]]></add>
		</operation>
		<operation error="log">
			<search position="after"><![CDATA[
			$data['text_download'] = $language->get('text_new_download');
			]]></search>
			<add><![CDATA[
			$data['text_serialkey'] = $language->get('text_new_serialkey');
			]]></add>
		</operation>
		<operation error="log">
			<search position="after"><![CDATA[
			$data['text_total'] = $language->get('text_new_total');
			]]></search>
			<add><![CDATA[
			$data['text_seriallink'] = $language->get('text_new_seriallink');
			]]></add>
		</operation>
		<operation error="log">
			<search position="before" index="5" offset="1"><![CDATA[
			$order_total_query
			]]></search>
			<add><![CDATA[
			/* added to show serials and links */
			if($order_sk_query->num_rows) {
				$data['serialkey'] = '';
				foreach ($order_sk_query->rows as $sk) {
					$data['serialkey'] .= $sk['productname'] . ": " . $sk['serialkey']. "\n\n";
				}
			}

			if($order_dl_query->num_rows) {
				$data['downloadlink'] = '';
				foreach ($order_dl_query->rows as $dl) {
					$data['downloadlink'] .= $dl['downloadlink'];
				}
			}
			]]></add>
		</operation>
		<operation error="log">
			<search position="after" offset="1"><![CDATA[
			$this->event->trigger('post.order.history.add', $order_id);
			]]></search>
			<add><![CDATA[
	public function getTotalOrders() {
		$query = $this->db->query("SELECT COUNT(*) AS total FROM `" . DB_PREFIX . "order` WHERE email = '" . $this->customer->getEmail() . "' AND date_added > DATE_SUB(NOW(), INTERVAL '" . (int)$this->config->get('config_restrict_hours') . "' HOUR) OR ip = '" . $_SERVER['REMOTE_ADDR'] . "' AND date_added > DATE_SUB(NOW(), INTERVAL '" . (int)$this->config->get('config_restrict_hours') . "' HOUR)");

		return $query->row['total'];
		}
			]]></add>
		</operation>
		<operation error="log">
			<search position="after"><![CDATA[
			$data['text_link'] = $language->get('text_new_link');
			]]></search>
			<add><![CDATA[
			$message = "";

			$query = $this->db->query("SELECT order_status_id FROM ".DB_PREFIX."order WHERE order_id = ".$order_id);

			foreach ($query->rows as $row)
				{
					$order_status = $row['order_status_id'];
				}

			$query = $this->db->query("SELECT serialkey FROM ".DB_PREFIX."order_serialkey
											WHERE order_id = ".$order_id);

			$complete_status = $this->config->get('config_complete_status');

			if ($query->num_rows && $order_status == $complete_status['0']) {
				foreach ($query->rows as $row)
					{
						$message .= "\n Your pin: ".strip_tags(html_entity_decode($row['serialkey'], ENT_QUOTES, 'UTF-8')) . "\n";
					}
					$message.="\n";
				}

			$data['text_link2'] = $language->get('text_new_link2').$message;
			]]></add>
		</operation>
		<operation error="log">
			<search position="after" index="1"><![CDATA[
			$data['link']
			]]></search>
			<add><![CDATA[
			$data['link2'] = $order_info['store_url'] . 'index.php?route=account/serial_keys';
			]]></add>
		</operation>
		<operation error="log">
			<search position="before" index="4"><![CDATA[
			$download_status
			]]></search>
			<add><![CDATA[
			$text .= $language->get('text_new_link2');
			$text .= $order_info['store_url'] . 'index.php?route=account/serial_keys' . "\n\n";
			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[
			if ($comment)
			]]></search>
			<add><![CDATA[
			$message .= $language->get('text_new_serialkey'). "\n";
			$message .= $order_info['store_url'] . 'index.php?route=account/serial_keys' . "\n\n";
			]]></add>
		</operation>
	</file>
	<file name="catalog/view/theme/*/template/mail/order.tpl">

		<operation error="log">
			<search position="before"><![CDATA[
			<?php echo $text_model; ?></td>
			]]></search>v
			<add><![CDATA[
			<td style="font-size: 12px; border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; background-color: #EFEFEF; font-weight: bold; text-align: left; padding: 7px; color: #222222;">Information</td>

			]]></add>
		</operation>
		<operation error="log">
			<search position="before"><![CDATA[
			<?php echo $product['model']; ?></td>
			]]></search>
			<add><![CDATA[
			        <td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: left; padding: 7px;"><?php echo $product['information']; ?></td>

			]]></add>
		</operation>
		<operation error="log">
			<search position="replace"><![CDATA[
<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;" colspan="4"><b><?php echo $total['title']; ?>:</b></td>
			]]></search>
			<add><![CDATA[
<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: right; padding: 7px;" colspan="5"><b><?php echo $total['title']; ?>:</b></td>
			]]></add>
		</operation>

	</file>
	<!-- CHECKOUT ORDER EDIT END -->
	<!-- CHECKOUT CART EDIT -->
	<file name="catalog/controller/checkout/cart.php">
		<operation error="log">
			<search position="after"><![CDATA[
			$this->language->get('button_checkout');
			]]></search>
			<add><![CDATA[
			if ($this->config->get('config_restrict_checkout') == 1) {
				$data['orders'] = array();
				$this->load->model('checkout/order');
				$order_total = $this->model_checkout_order->getTotalOrders();
			}

			]]></add>
		</operation>
		<operation error="log">
			<search position="after"><![CDATA[
			$data['error_warning'] = $this->language->get('error_stock');
			]]></search>
			<add><![CDATA[
			} elseif (($this->config->get('config_restrict_checkout') == 1) && ($order_total > 0)) {
				$data['error_warning'] = sprintf($this->language->get('error_restrict'),(INT)$this->config->get('config_restrict_hours'));
			]]></add>
		</operation>
	</file>
	<file name="catalog/language/*/checkout/cart.php">
		<operation error="log">
			<search position="before"><![CDATA[
			$_['error_minimum']
			]]></search>
			<add><![CDATA[
			/* RESTRICTED SHOPPING */
$_['error_restrict']         = 'Due to security you have no rights to buy products during %s hours from your last purchase.';
/* RESTRICTED SHOPPING END */
			]]></add>
		</operation>
	</file>
	<!-- CHECKOUT CART EDIT END -->
	<!-- CHECKOUT EDIT -->
	<file name="catalog/controller/checkout/checkout.php">
		<operation error="log">
			<search position="after"><![CDATA[
			public function index()
			]]></search>
			<add><![CDATA[
			/* RESTRICTED SHOPPING */
		// Validate restriced shopping and hours.

			if ($this->config->get('config_restrict_checkout') == 1) {


		$data['orders'] = array();
		$this->load->model('checkout/order');
		$order_total = $this->model_checkout_order->getTotalOrders();

		//var_dump($order_total);
			if ($order_total > 0) {
				$this->response->redirect($this->url->link('checkout/cart'));
			}
			}
		/* RESTRICTED SHOPPING END */
			]]></add>
		</operation>
	</file>
	<!-- CHECKOUT EDIT END -->
	<!-- ORDER MAIL EDIT -->
	<file name="catalog/language/*/mail/order.php">
		<operation error="log">
			<search position="before"><![CDATA[
			$_['text_update_subject']
			]]></search>
			<add><![CDATA[
$_['text_new_link2']        = 'To view your purchased Serial Key click on the link below:';
$_['text_new_serialkey']        = 'To view your purchased Serial Key click on the link below:';
			]]></add>
		</operation>
	</file>
	<!-- ORDER MAIL EDIT END -->
	<!-- FRONT MODS END -->


	<file name="admin/model/catalog/information.php">
		<operation error="log">
			<search position="before"><![CDATA[$sort_data = array(]]></search>
			<add><![CDATA[
			if (isset($data['like'])){
				$sql.=' AND id.title LIKE \''.$data['like'].'\' ';
			}
			]]></add>
		</operation>
	</file>
	<file name="admin/controller/catalog/information.php">
		<operation error="log">
			<search position="before"><![CDATA[public function delete() {]]></search>
			<add><![CDATA[
		public function autocomplete() {

			$this->load->model('catalog/information');

			$data = array();

			if(isset($this->request->get['like'])){
				$data['like'] = '%'.$this->request->get['like'].'%';
			}
			$data['limit'] = 5;
			$data['start'] = 0;

			$json = $this->model_catalog_information->getInformations($data);

			$this->response->addHeader('Content-Type: application/json');
			$this->response->setOutput(json_encode($json));
		}
			]]></add>
		</operation>
	</file>

	<file name="catalog/model/account/serial_keys.php">
		<operation>
			<search position="after"><![CDATA[
    $lang = $this->config->get('config_language_id');
	]]></search>
			<add><![CDATA[
    $conf_arr = $this->config->get('config_complete_status');
    $config_complete_status = "";
    $config_complete_status .= $conf_arr[0];
    foreach ( $conf_arr as $confs ) {
        if ( $confs != $conf_arr[0] ) {
            $config_complete_status .= "," . $confs;
        }
    }
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	o.customer_id = '" . (int)$this->customer->getId() . "' AND o.order_status_id = '" . $this->config->get('config_complete_status')[0] . "' ORDER BY o.date_added DESC LIMIT " . (int)$start . "," . (int)$limit;
	]]></search>
			<add><![CDATA[
	o.customer_id = '" . (int)$this->customer->getId() . "' AND o.order_status_id IN(" . $config_complete_status . ") ORDER BY o.date_added DESC LIMIT " . (int)$start . "," . (int)$limit;
			]]></add>
		</operation>
	</file>
</modification>
